{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <!-- Sekcja danych użytkownika -->
<h2 class="mb-4">Twoje dane</h2>
<div class="row mb-4" id="user-stats">
    <div class="col d-flex">
        <div class="card text-white bg-secondary flex-fill mx-1">
            <div class="card-body text-center py-3">
                <h6 class="card-title">Wiek</h6>
                <p class="card-text display-6">{{ age }}</p>
            </div>
        </div>
        <div class="card text-white bg-secondary flex-fill mx-1">
            <div class="card-body text-center py-3">
                <h6 class="card-title">Wzrost (cm)</h6>
                <p class="card-text display-6">{{ height }}</p>
            </div>
        </div>
        <div class="card text-white bg-secondary flex-fill mx-1">
            <div class="card-body text-center py-3">
                <h6 class="card-title">Waga (kg)</h6>
                <p class="card-text display-6">{{ weight }}</p>
            </div>
        </div>
        <div class="card text-white bg-secondary flex-fill mx-1">
            <div class="card-body text-center py-3">
                <h6 class="card-title">BMI</h6>
                <p class="card-text display-6">{{ bmi }}</p>
            </div>
        </div>
        <div class="card text-white bg-secondary flex-fill mx-1">
            <div class="card-body text-center py-3">
                <h6 class="card-title">PPM (kcal)</h6>
                <p class="card-text display-6">{{ ppm }}</p>
            </div>
        </div>
    </div>
</div>

    <!-- Podsumowanie tygodnia -->
    <h2 class="mb-4">Podsumowanie tygodnia</h2>
    <div class="row mb-4" id="today-stats">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Tygodniowe spożycie</h5>
                    <p class="card-text display-6" id="today-eaten">Ładowanie...</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">Tygodniowe spalanie</h5>
                    <p class="card-text display-6" id="today-burned">Ładowanie...</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Tygodniowe PPM (kcal)</h5>
                    <p class="card-text display-6" id="today-ppm">Ładowanie...</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white mb-3" id="today-balance-card">
                <div class="card-body">
                    <h5 class="card-title">Bilans tygodnia</h5>
                    <p class="card-text display-6" id="today-balance">Ładowanie...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela podsumowania tygodniowego -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Bilans z ostatnich 7 dni</h5>
            <button class="btn btn-sm btn-outline-secondary" id="refresh-data">
                <i class="bi bi-arrow-clockwise"></i> Odśwież
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Data</th>
                            <th>Spożyte (kcal)</th>
                            <th>Spalone (kcal)</th>
                            <th>PPM (kcal)</th>
                            <th>Bilans</th>
                            <th>Status</th>
                            <th>Posiłki</th>
                            <th>Aktywności</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-data">
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Ładowanie...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal do szczegółów dnia -->
<div class="modal fade" id="dayDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Szczegóły dnia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6" id="meals-col">
                        <h6><i class="bi bi-egg-fried"></i> Posiłki</h6>
                        <ul class="list-group" id="modal-meals"></ul>
                    </div>
                    <div class="col-md-6" id="activities-col">
                        <h6><i class="bi bi-bicycle"></i> Aktywności</h6>
                        <ul class="list-group" id="modal-activities"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('pl-PL', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    function loadWeeklyData() {
        const weeklyDataEl = document.getElementById('weekly-data');
        weeklyDataEl.innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Ładowanie...</span></div></td></tr>`;

        fetch('/api/weekly-summary/')
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                const summary = data.weekly_summary;
                const dailyData = data.daily_data;

                // Aktualizacja kart tygodniowych
                document.getElementById('today-eaten').textContent = `${summary.total_eaten} kcal`;
                document.getElementById('today-burned').textContent = `${summary.total_burned} kcal`;
                document.getElementById('today-ppm').textContent = `${summary.total_ppm} kcal`;

                const balanceEl = document.getElementById('today-balance');
                balanceEl.textContent = `${summary.balance} kcal`;

                const card = document.getElementById('today-balance-card');
                card.className = summary.balance > 0 ? 'card text-white bg-danger mb-3' :
                    summary.balance < 0 ? 'card text-white bg-success mb-3' :
                    'card text-white bg-secondary mb-3';

                if (!dailyData || dailyData.length === 0) {
                    weeklyDataEl.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-muted">Brak danych do wyświetlenia</td></tr>`;
                    return;
                }

                // Tabela z ostatnich 7 dni
                let html = '';
                dailyData.forEach(day => {
                    const date = new Date(day.date);
                    const isToday = date.toDateString() === new Date().toDateString();
                    const balanceClass = day.balance > 0 ? 'text-danger' : day.balance < 0 ? 'text-success' : '';
                    const statusBadge = day.balance > 0 ? 'bg-danger' : day.balance < 0 ? 'bg-success' : 'bg-secondary';

                    html += `<tr class="${isToday ? 'table-primary' : ''}">
                        <td><strong>${formatDate(day.date)}</strong> ${isToday ? '<span class="badge bg-info ms-2">Dziś</span>' : ''}</td>
                        <td>${day.total_eaten}</td>
                        <td>${day.total_burned}</td>
                        <td>${day.ppm}</td>
                        <td class="${balanceClass}">${day.balance}</td>
                        <td><span class="badge ${statusBadge}">${day.calorie_status}</span></td>
                        <td><button class="btn btn-sm btn-outline-primary" data-type="meals" data-meals='${JSON.stringify(day.meals)}' data-bs-toggle="modal" data-bs-target="#dayDetailsModal">Szczegóły</button></td>
                        <td><button class="btn btn-sm btn-outline-secondary" data-type="activities" data-activities='${JSON.stringify(day.activities)}' data-bs-toggle="modal" data-bs-target="#dayDetailsModal">Szczegóły</button></td>
                    </tr>`;
                });
                weeklyDataEl.innerHTML = html;
            })
            .catch(error => {
                weeklyDataEl.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Błąd ładowania danych: ${error.message}</td></tr>`;
            });
    }

    loadWeeklyData();
    document.getElementById('refresh-data').addEventListener('click', loadWeeklyData);

    const modal = document.getElementById('dayDetailsModal');
    modal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const mealsList = document.getElementById('modal-meals');
        const activitiesList = document.getElementById('modal-activities');
        const mealsCol = document.getElementById('meals-col');
        const activitiesCol = document.getElementById('activities-col');

        mealsList.innerHTML = '';
        activitiesList.innerHTML = '';

        if (button.dataset.type === 'meals' && button.dataset.meals) {
            JSON.parse(button.dataset.meals).forEach(m => mealsList.innerHTML += `<li class="list-group-item">${m}</li>`);
            mealsCol.style.display = 'block';
            activitiesCol.style.display = 'none';
        }
        else if (button.dataset.type === 'activities' && button.dataset.activities) {
            JSON.parse(button.dataset.activities).forEach(a => activitiesList.innerHTML += `<li class="list-group-item">${a}</li>`);
            mealsCol.style.display = 'none';
            activitiesCol.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
