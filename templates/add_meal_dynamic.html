{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-utensils me-2"></i>Dodaj posiłek</h4>
                </div>
                <div class="card-body">

                    <!-- Formularz wyszukiwania posiłku -->
                    <form id="searchForm" class="mb-4">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="mealInput" class="form-label">Wpisz nazwę posiłku:</label>
                                <input type="text" class="form-control" id="mealInput" name="meal" required
                                       placeholder="np. kanapka z serem, kurczak z ryżem...">
                            </div>
                            <div class="col-md-4">
                                <label for="mealDate" class="form-label">Data posiłku:</label>
                                <input type="date" class="form-control" id="mealDate" name="date" required>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Szukaj w Nutritionix
                            </button>
                        </div>
                    </form>

                    <!-- Wyniki wyszukiwania -->
                    <div id="searchResult" class="mb-4"></div>

                    <!-- Formularz dodawania ręcznego (zawsze widoczny) -->
                    <div class="card mb-3" id="manualFormCard">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">Dodaj ręcznie</h5>
                        </div>
                        <div class="card-body">
                            <form id="manualForm">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="manualMealName" class="form-label">Nazwa posiłku</label>
                                    <input type="text" class="form-control" id="manualMealName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="manualCalories" class="form-label">Kalorie</label>
                                    <input type="number" class="form-control" id="manualCalories" required>
                                </div>
                                <div class="mb-3">
                                    <label for="manualDate" class="form-label">Data posiłku</label>
                                    <input type="date" class="form-control" id="manualDate" required>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus-circle me-2"></i>Dodaj ręcznie
                                </button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        searchMeal();
    });

    function searchMeal() {
        const mealName = document.getElementById("mealInput").value;
        const resultDiv = document.getElementById("searchResult");
        resultDiv.innerHTML = '<div class="text-center my-4"><div class="spinner-border text-primary"></div><p>Wyszukuję posiłek...</p></div>';

        fetch("/api/nutritionix-meal/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({ meal: mealName })
        })
        .then(response => {
            if (!response.ok) throw new Error("Błąd zapytania");
            return response.json();
        })
        .then(data => {
            displayResults(data);
        })
        .catch(error => {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${error.message || "Błąd podczas wyszukiwania"}
                </div>
            `;
        });
    }

    function displayResults(data) {
        const resultDiv = document.getElementById("searchResult");
        const food = data.foods?.[0];

        if (!food) {
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>Nie znaleziono posiłku
                </div>
            `;
            return;
        }

        resultDiv.innerHTML = `
            <div class="card mb-3" data-food='${JSON.stringify(food)}'>
                <div class="card-header bg-light">
                    <h5 class="mb-0">Wynik: ${food.food_name}</h5>
                </div>
                <div class="card-body">
                    <p><strong>Kalorie:</strong> ${food.nf_calories} kcal</p>
                    <p><strong>Białko:</strong> ${food.nf_protein} g</p>
                    <p><strong>Węglowodany:</strong> ${food.nf_total_carbohydrate} g</p>
                    <p><strong>Tłuszcz:</strong> ${food.nf_total_fat} g</p>
                    <p><strong>Porcja:</strong> ${food.serving_qty} ${food.serving_unit}</p>
                    <button class="btn btn-success w-100" onclick="addMeal()">
                        <i class="fas fa-plus-circle me-2"></i>Dodaj posiłek
                    </button>
                </div>
            </div>
        `;
    }

    window.addMeal = function() {
        const resultDiv = document.getElementById("searchResult");
        const dateValue = document.getElementById("mealDate").value;

        if (!dateValue) {
            alert("Wybierz datę posiłku!");
            return;
        }

        const food = JSON.parse(resultDiv.querySelector(".card").dataset.food);

        fetch("/api/add-meal/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({
                foods: [food],
                date: dateValue
            })
        })
        .then(response => {
            if (!response.ok) throw new Error("Błąd podczas dodawania");
            return response.json();
        })
        .then(data => {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Posiłek dodany na ${data.date}!
                </div>
            `;
            document.getElementById("mealInput").value = "";
        })
        .catch(error => {
            alert(error.message || "Błąd podczas dodawania");
        });
    };

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
    }

    // Formularz ręczny
    document.getElementById("manualForm").addEventListener("submit", function(e) {
        e.preventDefault();

        const mealData = {
            foods: [{
                food_name: document.getElementById("manualMealName").value,
                nf_calories: parseFloat(document.getElementById("manualCalories").value),
                nf_protein: 0,
                nf_total_carbohydrate: 0,
                nf_total_fat: 0,
                serving_qty: 1,
                serving_unit: "portion"
            }],
            date: document.getElementById("manualDate").value
        };

        if (!mealData.date) {
            alert("Wybierz datę posiłku!");
            return;
        }

        fetch("/api/add-meal/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify(mealData)
        })
        .then(response => {
            if (!response.ok) throw new Error("Błąd podczas dodawania");
            return response.json();
        })
        .then(data => {
            document.getElementById("searchResult").innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Posiłek dodany na ${data.date}!
                </div>
            `;
            this.reset();
        })
        .catch(error => {
            alert(error.message || "Błąd podczas dodawania");
        });
    });
});
</script>
{% endblock %}
